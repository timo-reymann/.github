name: ORT License Compliance

on:
  workflow_call:
    inputs:
      ort-config-repo:
        description: Repository containing shared ORT config
        type: string
        default: timo-reymann/.github
      ort-config-ref:
        description: Branch/tag of the config repo
        type: string
        default: main
      ort-config-path:
        description: Path within the config repo where ORT config files live
        type: string
        default: ort-config
      report-formats:
        description: Comma-separated list of ORT report formats
        type: string
        default: PlainTextTemplate,StaticHtml,WebApp,PdfTemplate
      dependency-files:
        description: >
          Newline-separated list of file glob patterns (dorny/paths-filter syntax, each prefixed with '- ')
          that should trigger a full ORT run when changed.
        type: string
        default: |-
          - go.mod
          - **/go.mod
          - go.sum
          - **/go.sum
          - package.json
          - **/package.json
          - package-lock.json
          - **/package-lock.json
          - yarn.lock
          - **/yarn.lock
          - pnpm-lock.yaml
          - **/pnpm-lock.yaml
          - Cargo.toml
          - **/Cargo.toml
          - Cargo.lock
          - **/Cargo.lock
          - requirements.txt
          - **/requirements.txt
          - pyproject.toml
          - **/pyproject.toml
          - poetry.lock
          - **/poetry.lock
          - pom.xml
          - **/pom.xml
          - build.gradle
          - **/build.gradle
          - build.gradle.kts
          - **/build.gradle.kts
          - Gemfile
          - **/Gemfile
          - Gemfile.lock
          - **/Gemfile.lock
          - composer.json
          - **/composer.json
          - composer.lock
          - **/composer.lock
          - LICENSE
          - **/LICENSE
          - NOTICE
          - **/NOTICE

permissions:
  contents: read

jobs:
  changes:
    name: Check for dependency changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      dependencies: ${{ steps.filter.outputs.dependencies }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout ORT config
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ORT_CONFIG_REPO }}
          ref: ${{ env.ORT_CONFIG_REF }}
          path: ort-config

      - name: Check changed files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: ".ort-config/filters.yaml"

  ort:
    name: OSS Review Toolkit
    needs: changes
    if: needs.changes.outputs.dependencies == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    container:
      image: ghcr.io/oss-review-toolkit/ort
      options: --user 0:0
    env:
      ORT_CONFIG_REPO: ${{ inputs.ort-config-repo || 'timo-reymann/.github' }}
      ORT_CONFIG_REF: ${{ inputs.ort-config-ref || 'main' }}
      ORT_CONFIG_PATH: ${{ inputs.ort-config-path || 'ort-config' }}
      ORT_REPORT_FORMATS: ${{ inputs.report-formats || 'PlainTextTemplate,StaticHtml,WebApp,PdfTemplate' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout ORT config
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ORT_CONFIG_REPO }}
          ref: ${{ env.ORT_CONFIG_REF }}
          path: ort-config

      - name: Cache dependencies
        id: cache-dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            ~/.cache/go-build
            ~/.cache/pip
            ~/.cache/yarn
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.composer
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.ivy2/cache
            ~/.local/share/virtualenvs
            ~/.m2/repository
            ~/.npm
            ~/.nuget/packages
            !~/.nuget/packages/unwanted
            ~/.sbt
            ~/.stack-work
            ~/go/pkg/mod
            $HOME/$ORT_HOME_PATH/cache
          key: ort-deps-cache

      - name: Cache ORT
        id: cache-ort
        uses: actions/cache@v4
        with:
          path: |
            /root/.ort/scanner
          key: ort-cache

      - name: Prepare directories
        run: |
          mkdir -p ort/analyze ort/scanner ort/evaluation ort/report

      - name: Analyze
        run: |
          ort -c ort-config/$ORT_CONFIG_PATH/config.yml analyze -i . -o ort/analyze

      - name: Scan
        run: |
          ort -c ort-config/$ORT_CONFIG_PATH/config.yml scan -i ort/analyze/analyzer-result.yml -o ort/scanner

      - name: Evaluate
        id: evaluate
        run: |
          ort -c ort-config/$ORT_CONFIG_PATH/config.yml evaluate \
            --rules-file ort-config/$ORT_CONFIG_PATH/evaluator.rules.kts \
            --license-classifications-file ort-config/$ORT_CONFIG_PATH/license-classifications.yml \
            -i ort/scanner/scan-result.yml \
            -o ort/evaluation

      - name: Report
        if: always() && steps.evaluate.outcome != 'skipped'
        run: |
          ort -c ort-config/$ORT_CONFIG_PATH/config.yml report \
            -i ort/evaluation/evaluation-result.yml \
            -o ort/report \
            --report-formats $ORT_REPORT_FORMATS

      - name: Check NOTICE file
        id: notice-check
        if: always() && steps.evaluate.outcome != 'skipped'
        run: |
          if [ ! -f NOTICE ]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "reason=NOTICE file does not exist in the repository" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=$(head -100 ort/report/NOTICE_DEFAULT)
          elif ! diff -q NOTICE ort/report/NOTICE_DEFAULT > /dev/null 2>&1; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "reason=NOTICE file differs from generated NOTICE_DEFAULT" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=$(diff -u NOTICE ort/report/NOTICE_DEFAULT | head -100)
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=""
          fi

          {
            echo "diff<<NOTICE_DIFF_EOF"
            echo "$DIFF_OUTPUT"
            echo "NOTICE_DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Upload HTML report
        id: upload-html
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'StaticHtml')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-html
          path: ort/report/scan-report.html

      - name: Upload PDF report
        id: upload-pdf
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'PdfTemplate')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-pdf
          path: ort/report/AsciiDoc_disclosure_document.pdf

      - name: Upload plain text report
        id: upload-text
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'PlainTextTemplate')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-plain-text
          path: ort/report/NOTICE_DEFAULT

      - name: Upload WebApp report
        id: upload-webapp
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'WebApp')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-webapp
          path: ort/report/scan-report-web-app.html

      - name: Comment on PR
        if: always() && steps.evaluate.outcome != 'skipped' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = (id) => `${runUrl}/artifacts/${id}`;
            const lines = [];

            const htmlId = '${{ steps.upload-html.outputs.artifact-id }}';
            if (htmlId) {
              lines.push(`- [:page_facing_up: HTML Report](${artifactUrl(htmlId)})`);
            }
            const pdfId = '${{ steps.upload-pdf.outputs.artifact-id }}';
            if (pdfId) {
              lines.push(`- [:closed_book: PDF Report](${artifactUrl(pdfId)})`);
            }
            const textId = '${{ steps.upload-text.outputs.artifact-id }}';
            if (textId) {
              lines.push(`- [:pencil: Plain Text Report](${artifactUrl(textId)})`);
            }
            const webappId = '${{ steps.upload-webapp.outputs.artifact-id }}';
            if (webappId) {
              lines.push(`- [:globe_with_meridians: WebApp Report](${artifactUrl(webappId)})`);
            }

            const evaluate = '${{ steps.evaluate.outcome }}';
            const noticeOutdated = '${{ steps.notice-check.outputs.outdated }}' === 'true';
            const noticeReason = '${{ steps.notice-check.outputs.reason }}';
            const passed = evaluate === 'success' && !noticeOutdated;
            const status = passed ? ':white_check_mark: passed' : ':x: failed';

            const sections = [
              `## License Compliance â€” ${status}`,
              "I am using [ORT](https://oss-review-toolkit.org/ort/) to check for license compliance for added / modified library code. This helps adhering to license terms.",
              '',
              '### Reports',
              ...lines,
            ];

            if (noticeOutdated) {
              const noticeDiff = `${{ steps.notice-check.outputs.diff }}`;
              sections.push(
                '',
                '### :warning: NOTICE file out of date',
                `${noticeReason}. Please update the \`NOTICE\` file with the contents of the generated \`NOTICE_DEFAULT\`.`,
              );
              if (noticeDiff) {
                sections.push(
                  '',
                  '<details>',
                  '<summary>Diff (first 100 lines)</summary>',
                  '',
                  '```diff',
                  noticeDiff,
                  '```',
                  '',
                  '</details>',
                );
              }
            }

            sections.push('', `[View full run](${runUrl})`);

            const body = sections.join('\n');

            // Find and update existing comment or create new one
            const marker = '<!-- ort-license-compliance -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes(marker));
            const fullBody = `${marker}\n${body}`;

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: fullBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fullBody,
              });
            }
