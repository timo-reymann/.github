name: ORT License Compliance

on:
  workflow_call:
    inputs:
      ort-config-repo:
        description: Repository containing shared ORT config
        type: string
        default: timo-reymann/.github
      ort-config-ref:
        description: Branch/tag of the config repo
        type: string
        default: main
      ort-config-path:
        description: Path within the config repo where ORT config files live
        type: string
        default: ort-config
      report-formats:
        description: Comma-separated list of ORT report formats
        type: string
        default: PlainTextTemplate,StaticHtml,WebApp,PdfTemplate
      ort-filter-config:
        description: >
          Newline-separated list of file glob patterns (dorny/paths-filter syntax, each prefixed with '- ')
          that should trigger a full ORT run when changed.
        type: string
        default: |-
          dependencies:
            - "go.mod"
            - "**/go.mod"
            - "go.sum"
            - "**/go.sum"
            - "package.json"
            - "**/package.json"
            - "package-lock.json"
            - "**/package-lock.json"
            - "yarn.lock"
            - "**/yarn.lock"
            - "pnpm-lock.yaml"
            - "**/pnpm-lock.yaml"
            - "Cargo.toml"
            - "**/Cargo.toml"
            - "Cargo.lock"
            - "**/Cargo.lock"
            - "requirements.txt"
            - "**/requirements.txt"
            - "pyproject.toml"
            - "**/pyproject.toml"
            - "poetry.lock"
            - "**/poetry.lock"
            - "pom.xml"
            - "**/pom.xml"
            - "build.gradle"
            - "**/build.gradle"
            - "build.gradle.kts"
            - "**/build.gradle.kts"
            - "Gemfile"
            - "**/Gemfile"
            - "Gemfile.lock"
            - "**/Gemfile.lock"
            - "composer.json"
            - "**/composer.json"
            - "composer.lock"
            - "**/composer.lock"
            - "LICENSE"
            - "**/LICENSE"
            - "NOTICE"
            - "**/NOTICE"

permissions:
  contents: read

jobs:
  changes:
    name: Check for dependency changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write
    outputs:
      dependencies: ${{ steps.filter.outputs.dependencies }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: ${{ inputs.ort-filter-config }}

  ort:
    name: OSS Review Toolkit
    needs: changes
    if: needs.changes.outputs.dependencies == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    env:
      ORT_DOCKER_IMAGE: ghcr.io/oss-review-toolkit/ort
      ORT_HOME_PATH: .ort
      ORT_CONFIG_REPO: ${{ inputs.ort-config-repo || 'timo-reymann/.github' }}
      ORT_CONFIG_REF: ${{ inputs.ort-config-ref || 'main' }}
      ORT_CONFIG_PATH: ${{ inputs.ort-config-path || 'ort-config' }}
      ORT_REPORT_FORMATS: ${{ inputs.report-formats || 'PlainTextTemplate,StaticHtml,WebApp,PdfTemplate' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout ORT config
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ORT_CONFIG_REPO }}
          ref: ${{ env.ORT_CONFIG_REF }}
          path: ort-config

      - name: Prepare directories
        run: |
          mkdir -p $GITHUB_WORKSPACE/ort/{analyze,scanner,evaluation,report}
          mkdir -p $HOME/.ort/{cache,scanner/archive,scanner/file-lists,scanner/results,scanner/provenance}
          mkdir -p $HOME/.cache/scancode-tk
          mkdir -p $HOME/.config/jgit
          mkdir -p $HOME/.gradle
          chmod -R aug+w $HOME/.ort/ || :
          chmod -R aug+w $HOME/.cache/ || :
          chmod -R aug+w $HOME/.config/ || :
          chmod -R aug+w $HOME/.gradle/ || :

      - name: Restore dependency cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            ~/.cache/go-build
            ~/.cache/pip
            ~/.cache/yarn
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.composer
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.ivy2/cache
            ~/.local/share/virtualenvs
            ~/.m2/repository
            ~/.npm
            ~/.nuget/packages
            !~/.nuget/packages/unwanted
            ~/.sbt
            ~/.stack-work
            ~/go/pkg/mod
            ~/.ort/cache
          key: ${{ runner.os }}-ort-deps-cache-v2-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ort-deps-cache-v2-

      - name: Restore ORT scanner cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.ort/scanner
          key: ${{ runner.os }}-ort-scanner-cache-v2-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ort-scanner-cache-v2-

      - name: Pull ORT Docker image
        run: docker pull $ORT_DOCKER_IMAGE

      - name: Analyze
        run: |
          CONTAINER_WORKSPACE="${GITHUB_WORKSPACE/runner/ort}"
          docker run --mount type=bind,source=$HOME,target=/home/ort \
            -e JDK_JAVA_OPTIONS="-Xmx5120m" \
            -e ORT_DATA_DIR="/home/ort/$ORT_HOME_PATH" \
            -u $(id -u):$(id -g) \
            $ORT_DOCKER_IMAGE \
            -c $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/config.yml \
            analyze -i $CONTAINER_WORKSPACE -o $CONTAINER_WORKSPACE/ort/analyze

      - name: Scan
        run: |
          CONTAINER_WORKSPACE="${GITHUB_WORKSPACE/runner/ort}"
          docker run --mount type=bind,source=$HOME,target=/home/ort \
            -e JDK_JAVA_OPTIONS="-Xmx5120m" \
            -e ORT_DATA_DIR="/home/ort/$ORT_HOME_PATH" \
            -u $(id -u):$(id -g) \
            $ORT_DOCKER_IMAGE \
            -c $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/config.yml \
            scan -i $CONTAINER_WORKSPACE/ort/analyze/analyzer-result.yml \
            -o $CONTAINER_WORKSPACE/ort/scanner

      - name: Evaluate
        id: evaluate
        run: |
          CONTAINER_WORKSPACE="${GITHUB_WORKSPACE/runner/ort}"
          docker run --mount type=bind,source=$HOME,target=/home/ort \
            -e JDK_JAVA_OPTIONS="-Xmx5120m" \
            -e ORT_DATA_DIR="/home/ort/$ORT_HOME_PATH" \
            -u $(id -u):$(id -g) \
            $ORT_DOCKER_IMAGE \
            -c $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/config.yml \
            evaluate \
            --rules-file $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/evaluator.rules.kts \
            --license-classifications-file $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/license-classifications.yml \
            --package-curations-file $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/curations.yml \
            -i $CONTAINER_WORKSPACE/ort/scanner/scan-result.yml \
            -o $CONTAINER_WORKSPACE/ort/evaluation

      - name: Report
        if: always() && steps.evaluate.outcome != 'skipped'
        run: |
          CONTAINER_WORKSPACE="${GITHUB_WORKSPACE/runner/ort}"
          docker run --mount type=bind,source=$HOME,target=/home/ort \
            -e JDK_JAVA_OPTIONS="-Xmx5120m" \
            -e ORT_DATA_DIR="/home/ort/$ORT_HOME_PATH" \
            -u $(id -u):$(id -g) \
            $ORT_DOCKER_IMAGE \
            -c $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/config.yml \
            report \
            -i $CONTAINER_WORKSPACE/ort/evaluation/evaluation-result.yml \
            -o $CONTAINER_WORKSPACE/ort/report \
            --copyright-garbage-file $CONTAINER_WORKSPACE/ort-config/$ORT_CONFIG_PATH/copyright-garbage.yml \
            --report-formats $ORT_REPORT_FORMATS

      - name: Check NOTICE file
        id: notice-check
        if: always() && steps.evaluate.outcome != 'skipped'
        run: |
          if [ ! -f NOTICE ]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "reason=NOTICE file does not exist in the repository" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=$(head -100 ort/report/NOTICE_DEFAULT)
          elif ! diff -q --strip-trailing-cr NOTICE ort/report/NOTICE_DEFAULT > /dev/null 2>&1; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "reason=NOTICE file differs from generated NOTICE_DEFAULT" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=$(diff -u --strip-trailing-cr NOTICE ort/report/NOTICE_DEFAULT || true)
            DIFF_OUTPUT=$(echo "$DIFF_OUTPUT" | head -100)
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
            DIFF_OUTPUT=""
          fi

          {
            echo "diff<<NOTICE_DIFF_EOF"
            echo "$DIFF_OUTPUT"
            echo "NOTICE_DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Upload HTML report
        id: upload-html
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'StaticHtml')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-html
          path: ort/report/scan-report.html

      - name: Upload PDF report
        id: upload-pdf
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'PdfTemplate')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-pdf
          path: ort/report/AsciiDoc_disclosure_document.pdf

      - name: Upload plain text report
        id: upload-text
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'PlainTextTemplate')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-plain-text
          path: ort/report/NOTICE_DEFAULT

      - name: Upload WebApp report
        id: upload-webapp
        if: always() && steps.evaluate.outcome != 'skipped' && contains(env.ORT_REPORT_FORMATS, 'WebApp')
        uses: actions/upload-artifact@v4
        with:
          name: ort-report-webapp
          path: ort/report/scan-report-web-app.html

      - name: Save dependency cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            ~/.cache/go-build
            ~/.cache/pip
            ~/.cache/yarn
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.composer
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.ivy2/cache
            ~/.local/share/virtualenvs
            ~/.m2/repository
            ~/.npm
            ~/.nuget/packages
            !~/.nuget/packages/unwanted
            ~/.sbt
            ~/.stack-work
            ~/go/pkg/mod
            ~/.ort/cache
          key: ${{ runner.os }}-ort-deps-cache-v2-${{ github.run_id }}

      - name: Save ORT scanner cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.ort/scanner
          key: ${{ runner.os }}-ort-scanner-cache-v2-${{ github.run_id }}

      - name: Comment on PR
        if: always() && steps.evaluate.outcome != 'skipped' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = (id) => `${runUrl}/artifacts/${id}`;
            const lines = [];

            const htmlId = '${{ steps.upload-html.outputs.artifact-id }}';
            if (htmlId) {
              lines.push(`- [:page_facing_up: HTML Report](${artifactUrl(htmlId)})`);
            }
            const pdfId = '${{ steps.upload-pdf.outputs.artifact-id }}';
            if (pdfId) {
              lines.push(`- [:closed_book: PDF Report](${artifactUrl(pdfId)})`);
            }
            const textId = '${{ steps.upload-text.outputs.artifact-id }}';
            if (textId) {
              lines.push(`- [:pencil: Plain Text Report](${artifactUrl(textId)})`);
            }
            const webappId = '${{ steps.upload-webapp.outputs.artifact-id }}';
            if (webappId) {
              lines.push(`- [:globe_with_meridians: WebApp Report](${artifactUrl(webappId)})`);
            }

            const evaluate = '${{ steps.evaluate.outcome }}';
            const noticeOutdated = '${{ steps.notice-check.outputs.outdated }}' === 'true';
            const noticeReason = '${{ steps.notice-check.outputs.reason }}';
            const passed = evaluate === 'success' && !noticeOutdated;
            const status = passed ? ':white_check_mark: passed' : ':x: failed';

            const sections = [
              `## License Compliance â€” ${status}`,
              "I am using [ORT](https://oss-review-toolkit.org/ort/) to check for license compliance for added / modified library code. This helps adhering to license terms.",
              '',
              '### Reports',
              ...lines,
            ];

            if (noticeOutdated) {
              const noticeDiff = `${{ steps.notice-check.outputs.diff }}`;
              sections.push(
                '',
                '### :warning: NOTICE file out of date',
                `${noticeReason}. Please update the \`NOTICE\` file with the contents of the generated \`NOTICE_DEFAULT\`.`,
              );
              if (noticeDiff) {
                sections.push(
                  '',
                  '<details>',
                  '<summary>Diff (first 100 lines)</summary>',
                  '',
                  '```diff',
                  noticeDiff,
                  '```',
                  '',
                  '</details>',
                );
              }
            }

            sections.push('', `[View full run](${runUrl})`);

            const body = sections.join('\n');

            // Find and update existing comment or create new one
            const marker = '<!-- ort-license-compliance -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes(marker));
            const fullBody = `${marker}\n${body}`;

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: fullBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fullBody,
              });
            }

      - name: Create GitHub Checks
        if: always() && steps.evaluate.outcome != 'skipped' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const evaluate = '${{ steps.evaluate.outcome }}';
            const noticeOutdated = '${{ steps.notice-check.outputs.outdated }}' === 'true';
            const noticeReason = '${{ steps.notice-check.outputs.reason }}';
            const noticeDiff = `${{ steps.notice-check.outputs.diff }}`;

            // Create License Compliance Check
            const licenseCheck = {
              name: 'License Compliance',
              head_sha: context.sha,
              status: 'completed',
              conclusion: evaluate === 'success' ? 'success' : 'failure',
              output: {
                title: 'License Compliance Check',
                summary: evaluate === 'success' ? 'All licenses are compliant' : 'License compliance issues found',
                text: evaluate === 'success' ? 'The evaluation passed successfully.' : 'Please review the evaluation results.'
              }
            };

            // Create NOTICE File Check
            const noticeCheck = {
              name: 'NOTICE File',
              head_sha: context.sha,
              status: 'completed',
              conclusion: noticeOutdated ? 'failure' : 'success',
              output: {
                title: 'NOTICE File Check',
                summary: noticeOutdated ? 'NOTICE file is out of date' : 'NOTICE file is up to date',
                text: noticeOutdated ? noticeReason : 'The NOTICE file matches the generated NOTICE_DEFAULT.'
              }
            };

            if (noticeOutdated && noticeDiff) {
              noticeCheck.output.text += '\n\n```diff\n' + noticeDiff + '\n```';
            }

            // Create the checks
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ...licenseCheck
            });

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ...noticeCheck
            });
